name: Arduino CLI Compile

on:
  workflow_call:
    inputs:
      library_install_zip:
        description: 'The git link to the zip of the library repo at the exact has to build'
        required: true
        type: string
      arduino_job_matrix:
        description: 'A json string with the job matrix'
        required: true
        type: string

jobs:
  create_environment_caches:
    name: Create Arduino Caches
    runs-on: ubuntu-latest
    env:
      LIBRARY_INSTALL_ZIP: ${{ inputs.library_install_zip }}
      LOOKUP_ONLY: true

    steps:
      - &checkout_code
        name: Checkout code
        uses: actions/checkout@v5

      # We use the `arduino/setup-arduino-cli` action to install and
      # configure the Arduino CLI on the system.
      - &setup_arduino_cli
        name: Setup Arduino CLI
        uses: arduino/setup-arduino-cli@v2.0.0

      - &download_scripts
        name: Download the prepared scripts
        id: download_scripts
        uses: actions/download-artifact@v4
        with:
          name: generated_scripts
          path: |
            continuous_integration_artifacts/

      - &copy_scripts
        name: copy scripts into working directory, if needed
        id: copy_scripts
        run: |
          set -e
          if [ "$RUNNER_DEBUG" = "1" ]; then
              echo "Enabling debugging!"
              set -v
              set -x
          fi
          mkdir -p continuous_integration
          mv continuous_integration_artifacts/install-platforms-arduino-cli.sh install-platforms-arduino-cli.sh
          mv continuous_integration_artifacts/install-library-libdeps-arduino-cli.sh continuous_integration/install-library-libdeps-arduino-cli.sh
          mv continuous_integration_artifacts/install-example-libdeps-arduino-cli.sh continuous_integration/install-example-libdeps-arduino-cli.sh
          if [ -e continuous_integration_artifacts/arduino_cli.yaml ]
          then
            mv continuous_integration_artifacts/arduino_cli.yaml continuous_integration/arduino_cli.yaml || true
          fi

      - &cli_config
        name: Download Arduino CLI config
        id: cli_config
        run: |
          if [ ! -e ./continuous_integration/arduino_cli.yaml ]
          then
            curl -SL https://raw.githubusercontent.com/EnviroDIY/workflows/main/scripts/arduino_cli.yaml -o continuous_integration/arduino_cli.yaml
          fi

      - &restore_cores
        name: Restore Arduino Cores
        uses: actions/cache/restore@v4
        id: restore_cores
        with:
          path: |
            home/arduino/data
          key: arduino_platforms-${{ hashFiles('install-platforms-arduino-cli.sh') }}-${{ github.run_id }}-${{ matrix.job_info.job_tag }}
          restore-keys: |
            arduino_platforms-${{ hashFiles('install-platforms-arduino-cli.sh') }}-${{ github.run_id }}
            arduino_platforms-${{ hashFiles('install-platforms-arduino-cli.sh') }}
          lookup-only: ${{ env.LOOKUP_ONLY }}

      # Install cores for the Arduino CLI, iff no cache
      - &install_cores
        name: Install the Arduino Cores
        id: install_cores
        if: steps.restore_cores.outputs.cache-matched-key == ''
        run: |
          chmod +x install-platforms-arduino-cli.sh
          sh install-platforms-arduino-cli.sh

      # Upgrade all cores to the latest version, iff using cache
      # - &upgrade_cores
      #   name: Upgrade the Arduino Platforms
      #   id: upgrade_cores
      #   if: steps.restore_cores.outputs.cache-hit == 'true'
      #   run: |
      #     arduino-cli --config-file arduino_cli.yaml core upgrade

      - &restore_libraries
        name: Restore Arduino libraries
        uses: actions/cache/restore@v4
        id: restore_libraries
        with:
          path: |
            home/arduino/user
          key: arduino_libraries-${{ hashFiles('continuous_integration/install-library-libdeps-arduino-cli.sh', 'continuous_integration/install-example-libdeps-arduino-cli.sh') }}-${{ github.run_id }}-${{ matrix.job_info.job_tag }}
          restore-keys: |
            arduino_libraries-${{ hashFiles('continuous_integration/install-library-libdeps-arduino-cli.sh', 'continuous_integration/install-example-libdeps-arduino-cli.sh') }}-${{ github.run_id }}
            arduino_libraries-${{ hashFiles('continuous_integration/install-library-libdeps-arduino-cli.sh', 'continuous_integration/install-example-libdeps-arduino-cli.sh') }}
          lookup-only: ${{ env.LOOKUP_ONLY }}

      # Install any library dependencies for the Arduino CLI, iff no cache
      # NOTE: Don't update the dependencies beyond what's in the install script!
      - &install_libraries
        name: Install the Arduino libraries
        id: install_libraries
        if: ${{ (steps.restore_libraries.outputs.cache-matched-key == '') }}
        run: |
          chmod +x continuous_integration/install-library-libdeps-arduino-cli.sh
          sh continuous_integration/install-library-libdeps-arduino-cli.sh
          chmod +x continuous_integration/install-example-libdeps-arduino-cli.sh
          sh continuous_integration/install-example-libdeps-arduino-cli.sh

      - &cache_cores
        name: Cache Arduino Cores
        uses: actions/cache/save@v4
        id: cache_cores
        if: always() && steps.restore_cores.outputs.cache-matched-key == ''
        with:
          path: |
            home/arduino/data
          key: arduino_platforms-${{ hashFiles('install-platforms-arduino-cli.sh') }}-${{ github.run_id }}

      - &cache_libraries
        name: Cache Arduino Libraries
        uses: actions/cache/save@v4
        id: cache_libraries
        if: always() && steps.restore_libraries.outputs.cache-matched-key == ''
        with:
          path: |
            home/arduino/user
          key: arduino_libraries-${{ hashFiles('continuous_integration/install-library-libdeps-arduino-cli.sh', 'continuous_integration/install-example-libdeps-arduino-cli.sh') }}-${{ github.run_id }}

  build_arduino:
    name: ${{ matrix.job_info.job_name }}
    runs-on: ubuntu-latest
    needs: create_environment_caches
    env:
      LIBRARY_INSTALL_ZIP: ${{ inputs.library_install_zip }}
      LOOKUP_ONLY: false
    strategy:
      matrix:
        job_info: ${{ fromJSON(inputs.arduino_job_matrix) }}

    steps:
      - *checkout_code

      - name: Write the requirements file
        run: |
          echo "wheel" > requirements.txt
          echo "adafruit-nrfutil" >> requirements.txt

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
          cache: 'pip'

      - name: Install python dependencies, including NRF-Utils needed for Adafruit Feathers
        run: |
          pip install -r requirements.txt

      - *setup_arduino_cli
      - *download_scripts
      - *copy_scripts
      - *cli_config
      - *restore_cores
      - *install_cores
      # - *upgrade_cores
      - *restore_libraries
      - *install_libraries

      # Install the test library for the Arduino CLI
      - name: Install the testing version of the library for the Arduino CLI
        id: install_test_library
        run: |
          curl -SL https://raw.githubusercontent.com/EnviroDIY/workflows/main/scripts/install-test-version-arduino-cli.sh -o install-test-version-arduino-cli.sh
          chmod +x install-test-version-arduino-cli.sh
          sh install-test-version-arduino-cli.sh

      - name: Include problem matcher
        uses: ammaraskar/gcc-problem-matcher@master

      # Run the script to compile the examples
      - name: Compile
        id: compile_arduino_cli
        env:
          ACTION_RUN_ID: ${{ github.run_id }}
        run: |
          echo ::group::Installed Cores
          arduino-cli --config-file continuous_integration/arduino_cli.yaml core list
          echo ::endgroup::
          echo ::group::Installed Libraries
          arduino-cli --config-file continuous_integration/arduino_cli.yaml lib list
          echo ::endgroup::
          chmod +x ${{ matrix.job_info.script }}
          bash ${{ matrix.job_info.script }}

      - name: Uninstall testing version of the library before caching
        if: ${{ (steps.restore_libraries.outputs.cache-matched-key == '') }}
        run: |
          arduino-cli --config-file continuous_integration/arduino_cli.yaml lib uninstall ${GITHUB_REPOSITORY#*/}

      - *cache_cores
      - *cache_libraries
